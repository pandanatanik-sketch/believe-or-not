<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Тест — Верю / Не верю</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      background: #f4f5fb;
      color: #1f2933;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      background: #ffffff;
      padding: 20px 20px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
      max-width: 700px;
      width: 100%;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    .preview-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
      padding-left: 18px;
      font-size: 14px;
    }

    .preview-list li {
      margin-bottom: 4px;
    }

    .start-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #4b6bfb;
      color: #fff;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .category {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .question {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }

    .question-image {
      max-width: 100%;
      max-height: 260px;
      border-radius: 12px;
      object-fit: contain;
      margin-bottom: 14px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .true-btn {
      background: #4ade80;
      color: #064e3b;
    }

    .false-btn {
      background: #f87171;
      color: #7f1d1d;
    }

    .next-btn {
      background: #e5e7eb;
      color: #111827;
    }

    .feedback {
      font-size: 15px;
      margin-bottom: 10px;
      min-height: 20px;
    }

    .feedback.correct {
      color: #15803d;
    }

    .feedback.incorrect {
      color: #b91c1c;
    }

    .progress {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .final {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="card" id="card">
    <div class="title">Тест «Верю / Не верю»</div>
    <div class="subtitle">Сначала посмотри, какие будут вопросы, затем нажми «Начать тест».</div>

    <!-- Блок предварительного просмотра всех вопросов -->
    <div id="previewBlock">
      <ul class="preview-list" id="previewList"></ul>
      <button class="start-btn" id="startBtn">▶️ Начать тест</button>
    </div>

    <!-- Блок самого теста (по одному вопросу за раз) -->
    <div id="testBlock" style="display:none;">
      <div id="category" class="category"></div>
      <div id="question" class="question"></div>
      <img id="questionImage" class="question-image" src="" alt="Картинка к вопросу" style="display:none;" />

      <div class="buttons">
        <button class="true-btn" id="btnTrue">✅ Верю</button>
        <button class="false-btn" id="btnFalse">❌ Не верю</button>
        <button class="next-btn" id="btnNext" style="display:none;">➡️ Следующий</button>
      </div>

      <div id="feedback" class="feedback"></div>
      <div class="progress" id="progress"></div>
      <div class="final" id="final"></div>
    </div>
  </div>

  <script>
    // Ключ такой же, как в index.html
    const STORAGE_KEY = "believe_or_not_questions_v1";

    let questions = [];
    let index = 0;
    let score = 0;
    let answered = false;

    const previewBlockEl = document.getElementById("previewBlock");
    const previewListEl = document.getElementById("previewList");
    const startBtn = document.getElementById("startBtn");

    const testBlockEl = document.getElementById("testBlock");
    const categoryEl = document.getElementById("category");
    const questionEl = document.getElementById("question");
    const questionImageEl = document.getElementById("questionImage");
    const feedbackEl = document.getElementById("feedback");
    const progressEl = document.getElementById("progress");
    const finalEl = document.getElementById("final");
    const btnTrue = document.getElementById("btnTrue");
    const btnFalse = document.getElementById("btnFalse");
    const btnNext = document.getElementById("btnNext");
    const cardEl = document.getElementById("card");

    function loadQuestions() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return [];
        return JSON.parse(data);
      } catch (e) {
        console.warn("Ошибка чтения вопросов из LocalStorage", e);
        return [];
      }
    }

    function init() {
      questions = loadQuestions();

      if (!questions || questions.length === 0) {
        cardEl.innerHTML = `
          <div class="title">Вопросы не найдены</div>
          <div class="subtitle">
            Похоже, набор вопросов пуст. Открой сначала конструктор (index.html),
            добавь несколько карточек — и затем снова зайди сюда.
          </div>
        `;
        return;
      }

      // Показать список всех вопросов
      previewListEl.innerHTML = questions
        .map((q, i) => `<li><strong>${i + 1}.</strong> ${q.text}</li>`)
        .join("");

      startBtn.addEventListener("click", startTest);
    }

    function startTest() {
      // Скрываем просмотр, показываем тест
      previewBlockEl.style.display = "none";
      testBlockEl.style.display = "block";

      // Можно перемешать вопросы, если захочешь:
      // questions.sort(() => Math.random() - 0.5);

      index = 0;
      score = 0;
      answered = false;

      btnTrue.addEventListener("click", () => handleAnswer(true));
      btnFalse.addEventListener("click", () => handleAnswer(false));
      btnNext.addEventListener("click", nextQuestion);

      renderQuestion();
    }

    function renderQuestion() {
      const q = questions[index];
      questionEl.textContent = q.text;
      categoryEl.textContent = q.category ? "Категория: " + q.category : "";
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      finalEl.textContent = "";
      btnNext.style.display = "none";
      answered = false;

      // Показать/скрыть картинку
      if (q.imageData) {
        questionImageEl.src = q.imageData;
        questionImageEl.style.display = "block";
      } else {
        questionImageEl.src = "";
        questionImageEl.style.display = "none";
      }

      progressEl.textContent = "Вопрос " + (index + 1) + " из " + questions.length;
    }

    function handleAnswer(userAnswer) {
      if (answered) return; // чтобы не нажимали много раз
      answered = true;

      const q = questions[index];
      const isCorrect = userAnswer === q.correct;

      if (isCorrect) {
        score++;
        feedbackEl.textContent = "Верно!";
        feedbackEl.className = "feedback correct";
      } else {
        feedbackEl.textContent = "Неверно.";
        feedbackEl.className = "feedback incorrect";
      }

      if (q.explanation) {
        feedbackEl.textContent += " " + q.explanation;
      }

      btnNext.style.display = "inline-flex";
    }

    function nextQuestion() {
      if (!answered) return;

      index++;
      if (index >= questions.length) {
        showFinal();
      } else {
        renderQuestion();
      }
    }

    function showFinal() {
      cardEl.innerHTML = `
        <div class="title">Тест завершён!</div>
        <div class="final">Твой результат: ${score} из ${questions.length}</div>
        <div class="subtitle">Можно закрыть это окно или попробовать ещё раз, обновив страницу.</div>
      `;
    }

    init();
  </script>
</body>

</html>